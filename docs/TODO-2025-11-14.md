# TODO – 2025-11-15 (Fresh board)

Fresh start. Backlog preserved below. Use this section for new, high-impact tasks only.

## Today
- Connected QuickBooks Sandbox (OAuth) and confirmed realm (token stored)
- Added Import from QBO page (list/paginate customers and import)
- Refactored Add Items slide-over into tabs (Labor, Equipment, Materials, Subs, Other, Templates)
- Estimates index: bulk toolbar + persistent selection + click-to-filter
- Production QBO connected; redirect_uri and environment verified
- Import from QBO: Added Import Selected and Import All (paged) with proper token refresh and lite-field fallback
- Contacts: Added mobile field (DB migration, forms, model), and mapped QBO Mobile → mobile
- Contacts: Added QBO status badges (Linked / Synced / Needs Sync) and “Sync Now” action on Contact page
- Contacts: Added “Link to QBO” action (manual link by QBO Customer ID)
- Webhooks: Production webhook endpoint added and signature verification implemented

## In Progress
- QBO Import polish: simpler queries work (DisplayName + pagination). Add email/phone search as separate queries (no complex ORs)
- Equipment/Subs tabs: connect to real catalogs (Assets/Vendors) and rate presets
- Add “Sync to QBO” buttons (single + bulk) on Contacts
- QBO two-way sync: design + scaffolding (source-of-truth, conflict policy, webhook handler, CDC safety net)
- Outbound sync: Upsert uses minorversion=65, sparse=true, operation=update; fetches fresh SyncToken
- Inbound sync: Webhook handler maps safe first/last for company-only records; token refresh on 401

## Next Up
- Token refresh-on-demand (retry once on 401) and proactive refresh for background jobs
- Capture intuit_tid header in logs for QBO troubleshooting
- CDC cron: poll QBO Customer changes on a schedule to catch any missed webhooks
- Auto-link by email before creating a new contact from webhook to reduce duplicates
- Global setting + per-contact toggle for auto sync, plus loop prevention on inbound changes
- Work Area select + sticky footer in Add Items slide-over; persist last-used tab
- Finish Estimates bulk actions server handling (locked/archived fields), add toasts

## Blockers
- Windows cURL CA path issues in dev. Temporary fix: .env overrides for SSL_CERT_FILE and CURL_CA_BUNDLE; remove in prod and set php.ini curl.cainfo/openssl.cafile

## Notes
- Legal pages published for integrations (EULA/Privacy/Terms)
- Disconnect route uses POST; add GET if the portal mandates a GET link

## Completed Recently
- Theme: Sidebar to brand green; unified buttons/toasts
- Contacts: toolbar cleanup, compact buttons, selection count, brand link color
- Estimates index: removed filter bar; added selection column; bulk actions (status, reminders, lock, archive); persistent selection across pages (localStorage), shift-click, select-page, banner, filter chips
- Estimates show: brand inputs/buttons; Add Items slide-over converted to tabs; Equipment/Subs basic forms wired; Templates tab opens drawer
- QBO integration (Sandbox): config, migrations (qbo_tokens; qbo_customer_id/sync fields on clients), routes (launch/connect/callback/disconnect), settings page
- Legal pages: /legal/eula, /legal/privacy, /legal/terms
- QBO Import: /contacts/qbo/import page; fallback to DisplayName search and list mode with pagination; Contacts header “Import from QBO” button

## Known Issues / Follow-ups
- QBO query parser was erroring on complex OR/dotted fields; simplified to DisplayName search + list mode; email/phone search to be added as separate queries
- “Import from QBO” button reported as doing nothing on one machine; route exists and works directly; likely overlay/auth redirect/caching. Keep plain anchor and verify after cache clear
- Sync reliability: some production upserts appear to complete without visible change; add response/body logging (intuit_tid) under QBO_DEBUG to diagnose tenant-specific requirements
- Webhook created records failed due to null first_name on company-only customers; fixed mapper; monitor logs for any repeats
- Subs tab lacks Vendors data source; integrate Vendors model/catalog and mapping
- Equipment tab unit pricing defaults; optionally derive from Asset, add filter/presets
- Do not rely on .env CA overrides in production; configure php.ini cert paths and remove overrides

---

Ideas / Backlog
- Address autocomplete: optional inline “Address set” chip/toast on selection (and a small map preview under the field).
- Address UX follow-ups:
  - Add a Clear Address action that resets street + City/State/Zip.
  - Normalize US state to 2-letter uppercase on save; format ZIP as 5 or ZIP+4.
  - Add Address Line 2 to Contacts and auto-fill subpremise when present (mirrors Properties).
  - Pre-seed the picker on edit with the stored address text to improve visual continuity.
  - Add a debug flag (e.g., window.PLACES_DEBUG) to log the place object when selections are made.
- EmailLog table for granular email events (type, recipients, subject) beyond estimate-level counts
- Per-user preferences: last active contact tab, Comms filter defaults, Kanban visibility defaults
- Duplicate estimate items into a new estimate; optional multi-select import between estimates
- Spinners on Save & Append/Replace to avoid double submit; toasts standardized across pages
- EmailLog table for granular email events (type, recipients, subject) beyond estimate-level counts
- Per-user preferences: last active contact tab, Comms filter defaults, Kanban visibility defaults
- Duplicate estimate items into a new estimate; optional multi-select import between estimates
- Spinners on Save & Append/Replace to avoid double submit; toasts standardized across pages
