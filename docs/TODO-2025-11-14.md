# TODO – 2025-11-15 (Fresh board)

Fresh start. Backlog preserved below. Use this section for new, high-impact tasks only.

## Today
- Connected QuickBooks Sandbox (OAuth) and confirmed realm (token stored)
- Added Import from QBO page (list/paginate customers and import)
- Refactored Add Items slide-over into tabs (Labor, Equipment, Materials, Subs, Other, Templates)
- Estimates index: bulk toolbar + persistent selection + click-to-filter
- Production QBO connected; redirect_uri and environment verified
- Import from QBO: Added Import Selected and Import All (paged) with proper token refresh and lite-field fallback
- Contacts: Added mobile field (DB migration, forms, model), and mapped QBO Mobile → mobile
- Contacts: Added QBO status badges (Linked / Synced / Needs Sync) and “Sync to QBO / Refresh from QBO” actions (boxed UI + header button management)
- Contacts: Added “Link to QBO” action (manual link by QBO Customer ID)
- Webhooks: Production webhook endpoint added and signature verification implemented
- Queue daemon configured on Forge (database driver); saves no longer blocked by QBO calls
- Auto-sync safety: ContactObserver dispatchAfterResponse; QboSyncContact runs after commit and logs errors instead of crashing requests
- QBO debug logging (QBO_DEBUG) added with intuit_tid and response bodies for upsert/fetch
- CDC hourly job added (qbo:cdc:customers) to backfill Customer changes and balances
- Settings & Configurations: Admin menu and groups (Users, Estimates → Divisions, Cost Codes)
- Divisions: DB, seed, CRUD UI
- Cost Codes: DB, CRUD UI, mapping to QBO Service Items (dropdown loads QBO Service Items)
- Estimate types: Design/Build vs Maintenance; estimate-level Division and Cost Code fields added
- Invoice push: single-line invoice using estimate’s Cost Code → mapped QBO Service Item; description from estimate title (+areas summary for Design/Build)
- QBO item search endpoint (admin.qbo.items.search) with token refresh on 401
- Estimates create/edit form rebuilt: replaced complex Blade partial with a minimal _form_simple to stop Blade expressions rendering as text on some environments. Cost Code select now renders plain DB rows with no inline conditionals; selection handled simply.

## In Progress
- Standard Estimate redesign follow-ups:
  - Wire Work Area ordering by Order input (client-side DOM re-sort and server persistence endpoint)
  - Review alignment of the “Add Items + Templates” button (right-align on wide screens); ensure responsive wrapping
  - Small spacing/padding polish on header strip and metrics boxes
- QBO Import polish: simpler queries work (DisplayName + pagination). Add email/phone search as separate queries (no complex ORs)
- Equipment/Subs tabs: connect to real catalogs (Assets/Vendors) and rate presets
- Contacts: bulk “Sync to QBO” on list (toolbar) [UI next]
- QBO two-way sync: design + scaffolding (source-of-truth, conflict policy, webhook handler, CDC safety net)
- Outbound sync (Customer): Upsert uses minorversion=65, sparse=true, operation=update; fetch fresh SyncToken; minimal payload (PrimaryEmailAddr, PrimaryPhone, BillAddr only).
- Inbound sync (Customer): Webhook + CDC map names safely, PrimaryEmailAddr/PrimaryPhone/Mobile/BillAddr; token refresh on 401; balance mapped to qbo_balance.
- Estimates: cost-code-only invoicing (no materials), enforce cost_code_id required on estimate; form now uses simple Blade to maximize compatibility across PHP/Laravel/LTS combos.
- QBO items dropdown: ensure stable rendering on all environments (avoid Blade helpers); add error/empty states

## Next Up
- Estimates (Design/Build): implement POST /estimates/{estimate}/areas/reorder to persist Work Area order (accepts [{ id, sort_order }]); wire client-side Order input to re-sort DOM and call endpoint. Consider adding drag-and-drop ordering as an enhancement
- Invoices: Webhook + CDC ingestion for Invoice status/balance; add “View in QBO” link; optional push updates pre‑payment.
- QBO settings (Estimates): default invoice item (fallback), Terms & Conditions by type, Status sets by type
- Token refresh-on-demand (retry once on 401) and proactive refresh for background jobs
- Capture intuit_tid header in logs for all QBO calls (broadened)
- Auto-link by email before creating a new contact from webhook to reduce duplicates
- Global setting + per-contact toggle for auto sync, plus loop prevention on inbound changes
- Work Area select + sticky footer in Add Items slide-over; persist last-used tab
- Finish Estimates bulk actions server handling (locked/archived fields), add toasts

## Blockers
- Windows cURL CA path issues in dev. Temporary fix: .env overrides for SSL_CERT_FILE and CURL_CA_BUNDLE; remove in prod and set php.ini curl.cainfo/openssl.cafile

## Notes
- Legal pages published for integrations (EULA/Privacy/Terms)
- Disconnect route uses POST; add GET if the portal mandates a GET link

## Completed Recently
- Theme: Sidebar to brand green; unified buttons/toasts
- Contacts: toolbar cleanup, compact buttons, selection count, brand link color
- Estimates index: removed filter bar; added selection column; bulk actions (status, reminders, lock, archive); persistent selection across pages (localStorage), shift-click, select-page, banner, filter chips
- Estimates show: brand inputs/buttons; Add Items slide-over converted to tabs; Equipment/Subs basic forms wired; Templates tab opens drawer
- Standard Estimate redesign (UI):
  - Work Areas wrapper uses a blueish-gray perimeter (bg-slate-100) with a white inner content area
  - “Add Work Area” moved into a header strip above the areas list (light gray bar)
  - Area header standardized: Collapse, Order, Name, Id, Cost Code; metrics (Hrs/COGS/Price/Profit) shown as labeled white boxes in the same row
  - Added “Add Items + Templates” button in the header; opens the Items slide-over directly on the Templates tab
  - Pricing/Notes sections retain white background; only the perimeter area shows the subtle blue-gray
  - Customer Info tab bar restyled to pill tabs; increased font size for readability
- QBO integration (Sandbox): config, migrations (qbo_tokens; qbo_customer_id/sync fields on clients), routes (launch/connect/callback/disconnect), settings page
- Legal pages: /legal/eula, /legal/privacy, /legal/terms
- QBO Import: /contacts/qbo/import page; fallback to DisplayName search and list mode with pagination; Contacts header “Import from QBO” button

## Known Issues / Follow-ups
- Work Area “Order” input currently does not re-order areas in all environments (wiring pending). Needs DOM re-sort on input change + server reorder endpoint to persist order across refreshes
- QBO query parser was erroring on complex OR/dotted fields; simplified to DisplayName search + list mode; email/phone search to be added as separate queries
- “Import from QBO” button reported as doing nothing on one machine; route exists and works directly; likely overlay/auth redirect/caching. Keep plain anchor and verify after cache clear
- Customer update: 2010 ValidationFault resolved by minimal sparse payload and unwrapped update body. Mobile and names update available via explicit actions only.
- Invoices: Initial failures when auto‑creating Services Item due to AccountType filter; adjusted to AccountType=Income, with fallbacks to Classification=Revenue and broad listing. Add UI to select an existing Item/Account to bypass creation.
- Intermittent 401/100 auth faults observed; retry after refresh is in place, continue monitoring
- Webhook created records failed due to null first_name on company-only customers; fixed mapper; monitor logs
- Subs tab lacks Vendors data source; integrate Vendors model/catalog and mapping
- Equipment tab unit pricing defaults; optionally derive from Asset, add filter/presets
- Do not rely on .env CA overrides in production; configure php.ini cert paths and remove overrides
- Blade rendering variance: On some PHP/Laravel setups, conditional attribute helpers printed as text. Resolved by replacing the Estimate form with a minimal template that avoids inline conditionals entirely and uses straight DB lists.

---

Ideas / Backlog
- Address autocomplete: optional inline “Address set” chip/toast on selection (and a small map preview under the field).
- Address UX follow-ups:
  - Add a Clear Address action that resets street + City/State/Zip.
  - Normalize US state to 2-letter uppercase on save; format ZIP as 5 or ZIP+4.
  - Add Address Line 2 to Contacts and auto-fill subpremise when present (mirrors Properties).
  - Pre-seed the picker on edit with the stored address text to improve visual continuity.
  - Add a debug flag (e.g., window.PLACES_DEBUG) to log the place object when selections are made.
- EmailLog table for granular email events (type, recipients, subject) beyond estimate-level counts
- Per-user preferences: last active contact tab, Comms filter defaults, Kanban visibility defaults
- Duplicate estimate items into a new estimate; optional multi-select import between estimates
- Spinners on Save & Append/Replace to avoid double submit; toasts standardized across pages
- EmailLog table for granular email events (type, recipients, subject) beyond estimate-level counts
- Per-user preferences: last active contact tab, Comms filter defaults, Kanban visibility defaults
- Duplicate estimate items into a new estimate; optional multi-select import between estimates
- Spinners on Save & Append/Replace to avoid double submit; toasts standardized across pages
