# TODO – 2025-11-14 (Templates + Calculator UX)

Use this checklist to continue the templates work and polish the calculator UX inside Estimates.

## 1) Estimate UI – “Add via Calculator” Modal/Drawer
- [ ] Add a modal/drawer on estimates.show for “Add via Calculator” (top right actions)
- [ ] Two tabs: "Create with Calculator" | "Templates"
- [ ] Create tab:
  - [ ] Button: “Open Mulching (Template Mode)” -> /calculators/mulching?mode=template&estimate_id={id}
  - [ ] (Stretch) Inline mini-form for Mulching (Template Mode) with Save Template / Import
- [ ] Templates tab:
  - [ ] Load mulching templates via GET estimates/{estimate}/calculator/templates?type=mulching
  - [ ] Show name + date, optional preview (materials/labor/final)
  - [ ] Import (Append) and Import (Replace) buttons
  - [ ] Add a small “Refresh” button next to the list
- [ ] QA: verify success toast, reload line items, totals update

## 2) Mulching Template Mode – Polish
- [ ] Auto-suggest template_name (e.g., "Front Beds – 2.5 yd") based on inputs
- [ ] Inline preview of totals (Materials/Labor/Final) near footer actions
- [ ] Validate template_name (required) in template mode before save
- [ ] Replace toggle only shown when estimate_id present
- [ ] (Stretch) Choose Work Area before import; pass area_id into import flow

## 3) Extend Template Mode to Other Calculators
- [ ] Planting: support mode=template in controller + view actions
- [ ] Retaining Wall: support mode=template in controller + view actions
- [ ] Estimate UI: add similar panels (or modal entries) for these calculators
- [ ] QA: append/replace behavior, budget margins carried through

## 4) Template Management (Gallery)
- [ ] Route + Controller + Blade: /calculator/templates (list)
- [ ] Filters: by type, search by name, date range
- [ ] Actions: Rename, Delete, (future) Duplicate
- [ ] Permissions: mark templates as global or owner-only (add created_by, is_global)
- [ ] QA: confirm templates list reflects changes immediately

## 5) API / Backend
- [ ] Add endpoints for rename/delete template
  - [ ] PATCH /calculator/templates/{id} (template_name)
  - [ ] DELETE /calculator/templates/{id}
- [ ] (Optional) Add GET /calculator/templates?type=... (global list)
- [ ] Ensure EstimateCalculatorController returns consistent JSON on errors

## 6) Data / Migrations
- [ ] Add DB index on calculations: (is_template, calculation_type) to speed template listing
- [ ] Backfill script (artisan cmd) to set is_template=1 for prior template rows if needed
- [ ] Verify site_visit_id nullable migration in all envs; handle foreign key gracefully

## 7) Docs
- [ ] README: Document Template Mode and in-estimate workflow
- [ ] Update docs/WORKLOG-2025-11-13-templates-and-ui.md after completing today’s tasks
- [ ] Add animated GIF or screenshots of the new flow

## 8) QA / Regression
- [ ] Test mulching template save/import on: Chrome/Edge; mobile widths
- [ ] Verify calculations import with budget margin logic (CalculationImportService)
- [ ] Verify append vs replace behavior on repeated imports
- [ ] Verify route list for new endpoints: `php artisan route:list | Select-String "calculator"`
- [ ] Verify error handling (invalid template id, missing estimate, etc.)

## 9) Nice-to-haves (Optional)
- [ ] Template tags (e.g., Residential, Commercial, Beds, Trees)
- [ ] Duplicate estimate items into a new estimate
- [ ] Apply default Work Area on import and allow user override

## File Pointers
- Routes: `routes/web.php`
- Controllers: `MulchingCalculatorController`, `EstimateCalculatorController`
- Views:
  - Estimate: `resources/views/estimates/show.blade.php`
  - Mulching form: `resources/views/calculators/mulching/form.blade.php`
  - Shared partials: `resources/views/calculators/partials/*.blade.php`
- Model: `app/Models/Calculation.php`
- Migrations: see `database/migrations` (template fields; site_visit_id nullable)
- Services: `app/Services/CalculationImportService.php`

## Commands
- Clear caches: `php artisan optimize:clear`
- Migrate: `php artisan migrate`
- Assets: `npm run dev` or `npm run build`
- Route check: `php artisan route:list | Select-String "calculator"`

---
Add owners and timestamps next to tasks as you work through the list.
