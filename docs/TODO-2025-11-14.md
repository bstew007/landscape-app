# TODO – 2025-11-14 (Templates + Calculator UX + Syn-Turf Enhancements)

Current status summary is at the top; detailed tasks follow.

## Current Status (as of 2025-11-14)
- Template Mode implemented for: Mulching, Syn-Turf, Paver Patio, Retaining Wall, Weeding, Turf Mowing, and extended to Planting, Fence, Pruning, Pine Needles.
- Estimate page:
  - “Add via Calculator” drawer with Templates tab and Refresh button.
  - Refresh button added to the page; auto-refresh and spinner wired to common item actions.
  - Work area headers now use area names instead of raw IDs (no more “Area 5” labels).
- Append/Replace from calculator results: fixed to redirect to estimates.show and to post estimate_id/calculation_id reliably.
- Syn-Turf enhancements:
  - Production rates updated: faster infill (0.0025 hr/sqft), excavation via CY for equipment, added base_install (0.20 hr/cy).
  - Excavation Method toggle in form (Generic/Skid Steer/Mini Skid) + Excavation Depth (in) => CY.
  - ABC and Rock Dust added as separate materials (CY) via independent depths.
  - Motorized hand tamper rental added as a fee ($125/day) with Rental Days input.

Use this checklist to continue the templates work and polish the calculator UX inside Estimates.

---

Status Update – 2025-11-14 EOD
- To‑Do Kanban
  - Added “Future” status/bucket with auto-assignment when due_date > 30 days
  - Added Hide Future and Hide Completed filters; Future column is always visible; drag-and-drop preserved
  - Changed todos.status to string (migration) to support new statuses
- Contacts Revamp
  - New tabbed layout (Info, Properties, Estimates, Invoices, Communications)
  - Properties: Quick Add slide‑over; inline “Set Primary” action
  - Communications: timeline with To‑Dos (inline status), Estimate Email events, and Site Visits; filters for type/status/date
  - Fixed edit flow redirects and added phone input masking + server normalization to (XXX) XXX-XXXX
- Estimates UX
  - Global toast helper added so success/error toasts display consistently
  - Drawer and templates tab wired; imports append/replace and totals refresh
- Misc
  - Sidebar icons unified for Admin items (Production Rates, Company Budget, Materials)
  - Invoices tab fixed to query via estimates.client_id (no invoices.client_id)

Remaining (near term)
- Calculators
  - QA append/replace and budget margin behavior across all calculators
  - Ensure EstimateCalculatorController returns consistent JSON on errors
  - README + GIF/screenshots for Template Mode and in-estimate workflow
- Contacts/Comms polish
  - Optional: AJAX (no-reload) inline To‑Do edits; chip filters; toasts after inline actions
  - Properties: convert Edit to slide‑over; add toasts for Quick Add / Set Primary
  - Mobile QA for tabs/slide-overs
- Templates/Gallery
  - Cross-browser QA (Chrome/Edge/Safari) + mobile widths
  - Optional: template tags; duplicate estimate into new estimate; default Work Area on import
- Data
  - Optional backfill script to set is_template=1 on legacy rows if needed

Open Issues (Actionable)
- Materials
  - [ ] Fix 404 on POST materials/bulk in production (route cache or middleware ability). Quick diag: use explicit action url('/materials/bulk'); test a temporary GET ping route; ensure user has can:manage-catalogs.
  - [ ] Confirm bulk actions (delete/activate/inactivate/change category) end-to-end; add confirm dialog for delete; disable Apply until action selected.
  - [ ] Consider “Select all matching search” (cross-page select) to act on all filtered results.
- Syn‑Turf
  - [ ] Move Excavation Method toggle higher in the form for visibility.
  - [ ] Optional: auto-calc tamper rental days (ceil(total hours / 8)) with manual override.
  - [ ] Result footer: allow selecting Work Area and pass area_id on import.
- Template Mode
  - [ ] README + screenshots/GIFs for Template Mode and estimate drawer flow.
  - [ ] Final QA of append/replace and budget margins across all calculators.
- Estimate Drawer
  - [ ] Confirm Template Gallery pre-filters by calculator type and supports Work Area selection on import.

Ideas / Backlog
- EmailLog table for granular email events (type, recipients, subject) beyond estimate-level counts
- Per-user preferences: last active contact tab, Comms filter defaults, Kanban visibility defaults
- Duplicate estimate items into a new estimate; optional multi-select import between estimates
- Spinners on Save & Append/Replace to avoid double submit; toasts standardized across pages


## 1) Estimate UI – “Add via Calculator” Modal/Drawer
- [x] Add a modal/drawer on estimates.show for “Add via Calculator” (top right actions) — Owner: AI, 2025-11-14
- [x] Two tabs: "Create with Calculator" | "Templates" — Owner: AI, 2025-11-14
- [x] Create tab:
  - [x] Button: “Open Mulching (Template Mode)” -> /calculators/mulching?mode=template&estimate_id={id} (implemented as dynamic per selected calculator) — Owner: AI, 2025-11-14
  - [ ] (Stretch) Inline mini-form for Mulching (Template Mode) with Save Template / Import
- [x] Templates tab:
  - [x] Load templates via GET estimates/{estimate}/calculator/templates?type={type} — Owner: AI, 2025-11-14
  - [x] Show name + date (basic list) — Owner: AI, 2025-11-14
  - [x] Import (Append) and Import (Replace) buttons — Owner: AI, 2025-11-14
  - [x] Add a small “Refresh” button next to the list — Owner: AI, 2025-11-14
- [x] QA: verify success toast, reload line items, totals update — via global toast helper and estimate UI auto-refresh

## 2) Mulching Template Mode – Polish (and generalize to other calculators)
- [x] Auto-suggest template_name (e.g., "Front Beds – 2.5 yd") based on inputs — Owner: AI, 2025-11-14
- [x] Inline preview of totals (Materials/Labor/Final) near footer actions — Owner: AI, 2025-11-14
- [x] Validate template_name (required) in template mode before save — Owner: AI, 2025-11-14
- [ ] Replace toggle only shown when estimate_id present
- [x] (Stretch) Choose Work Area before import; pass area_id into import flow (gallery import supports area_id) — Owner: AI, 2025-11-14

## 3) Extend Template Mode to Other Calculators
- [x] Planting: support mode=template in controller + view actions
- [x] Retaining Wall: support mode=template in controller + view actions
- [x] Fence, Pruning, Pine Needles: added support and UI hooks
- [ ] QA: append/replace behavior, budget margins carried through — Owner: AI (pending), 2025-11-14

## 4) Template Management (Gallery)
- [x] Route + Controller + Blade: /calculator/templates (list) — Owner: AI, 2025-11-14
- [x] Filters: by type, search by name, date range — Owner: AI, 2025-11-14
- [x] Actions: Rename, Delete, Duplicate — Owner: AI, 2025-11-14
- [x] Permissions: add created_by, is_global; basic policy for view/update/delete/duplicate — Owner: AI, 2025-11-14
- [x] Import Modal: estimate search, Replace toggle, Work Area select, redirects to estimate — Owner: AI, 2025-11-14
- [x] Sidebar link to Gallery + “Go to Gallery” from estimate drawer (pre-filtered by type) — Owner: AI, 2025-11-14
- [ ] QA: confirm templates list and actions on Chrome/Edge + mobile widths

## 5) API / Backend
- [x] Add endpoints for rename/delete template — Owner: AI, 2025-11-14
  - [x] PATCH /calculator/templates/{id} (template_name)
  - [x] DELETE /calculator/templates/{id}
- [x] GET /calculator/templates?type=... (gallery filters) — Owner: AI, 2025-11-14
- [x] Duplicate endpoint: POST /calculator/templates/{id}/duplicate — Owner: AI, 2025-11-14
- [x] Import endpoint: POST /calculator/templates/{id}/import (estimate_id, replace, area_id) — Owner: AI, 2025-11-14
- [ ] Ensure EstimateCalculatorController returns consistent JSON on errors

## 6) Data / Migrations
- [x] Add DB index on calculations: (is_template, calculation_type) to speed template listing — Owner: AI, 2025-11-14
- [ ] Backfill script (artisan cmd) to set is_template=1 for prior template rows if needed
- [ ] Verify site_visit_id nullable migration in all envs; handle foreign key gracefully

## 7) Docs
- [ ] README: Document Template Mode and in-estimate workflow
- [x] Update docs/WORKLOG-2025-11-13-templates-and-ui.md
- [ ] Add animated GIF or screenshots of the new flow

## 8) QA / Regression
- [ ] Test mulching template save/import on: Chrome/Edge; mobile widths
- [ ] Verify calculations import with budget margin logic (CalculationImportService)
- [ ] Verify append vs replace behavior on repeated imports
- [ ] Verify route list for new endpoints: `php artisan route:list | Select-String "calculator"`
- [ ] Verify error handling (invalid template id, missing estimate, etc.)

## 9) Nice-to-haves (Optional)
- [ ] Result footer: allow selecting Work Area and pass area_id to import
- [ ] Inline spinners on Save & Append/Replace to avoid double submit
- [ ] Template tags (e.g., Residential, Commercial, Beds, Trees)
- [ ] Duplicate estimate items into a new estimate
- [ ] Apply default Work Area on import and allow user override

## File Pointers
- Routes: `routes/web.php`
- Controllers: `MulchingCalculatorController`, `EstimateCalculatorController`, `SiteVisitController`, `SynTurfCalculatorController`, plus other calculator controllers (Fence, Planting, Pruning, Pine Needles, Retaining Wall, Paver Patio, Weeding, Turf Mowing)
- Views:
  - Estimate: `resources/views/estimates/show.blade.php`
  - Syn-Turf form: `resources/views/calculators/syn-turf/form.blade.php`
  - Shared partials: `resources/views/calculators/partials/*.blade.php`
- Services: `app/Services/CalculationImportService.php`, `app/Services/SynTurfMaterialService.php`, `app/Services/LaborCostCalculatorService.php`
- Config: `config/syn_turf.php`
- Seeders: `database/seeders/ProductionRateSeeder.php`, data: `database/seeders/data/production_rates.json`

## Commands
- Clear caches: `php artisan optimize:clear`
- Migrate: `php artisan migrate`
- Seed production rates (important for Syn-Turf changes): `php artisan db:seed --class=ProductionRateSeeder`
- Views cache clear: `php artisan view:clear`
- Assets: `npm run dev` or `npm run build`
- Route check: `php artisan route:list | Select-String "calculator"`

---
Add owners and timestamps next to tasks as you work through the list.
