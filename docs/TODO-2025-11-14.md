# TODO – 2025-11-14 (Templates + Calculator UX + Syn-Turf Enhancements)

Current status summary is at the top; detailed tasks follow.

## Current Status (as of 2025-11-14)
- Template Mode implemented for: Mulching, Syn-Turf, Paver Patio, Retaining Wall, Weeding, Turf Mowing, and extended to Planting, Fence, Pruning, Pine Needles.
- Estimate page:
  - “Add via Calculator” drawer with Templates tab and Refresh button.
  - Refresh button added to the page; auto-refresh and spinner wired to common item actions.
  - Work area headers now use area names instead of raw IDs (no more “Area 5” labels).
- Append/Replace from calculator results: fixed to redirect to estimates.show and to post estimate_id/calculation_id reliably.
- Syn-Turf enhancements:
  - Production rates updated: faster infill (0.0025 hr/sqft), excavation via CY for equipment, added base_install (0.20 hr/cy).
  - Excavation Method toggle in form (Generic/Skid Steer/Mini Skid) + Excavation Depth (in) => CY.
  - ABC and Rock Dust added as separate materials (CY) via independent depths.
  - Motorized hand tamper rental added as a fee ($125/day) with Rental Days input.

Use this checklist to continue the templates work and polish the calculator UX inside Estimates.

## 1) Estimate UI – “Add via Calculator” Modal/Drawer
- [ ] Add a modal/drawer on estimates.show for “Add via Calculator” (top right actions)
- [ ] Two tabs: "Create with Calculator" | "Templates"
- [ ] Create tab:
  - [ ] Button: “Open Mulching (Template Mode)” -> /calculators/mulching?mode=template&estimate_id={id}
  - [ ] (Stretch) Inline mini-form for Mulching (Template Mode) with Save Template / Import
- [ ] Templates tab:
  - [ ] Load mulching templates via GET estimates/{estimate}/calculator/templates?type=mulching
  - [ ] Show name + date, optional preview (materials/labor/final)
  - [ ] Import (Append) and Import (Replace) buttons
  - [ ] Add a small “Refresh” button next to the list
- [ ] QA: verify success toast, reload line items, totals update

## 2) Mulching Template Mode – Polish (and generalize to other calculators)
- [ ] Auto-suggest template_name (e.g., "Front Beds – 2.5 yd") based on inputs
- [ ] Inline preview of totals (Materials/Labor/Final) near footer actions
- [ ] Validate template_name (required) in template mode before save
- [ ] Replace toggle only shown when estimate_id present
- [ ] (Stretch) Choose Work Area before import; pass area_id into import flow

## 3) Extend Template Mode to Other Calculators
- [x] Planting: support mode=template in controller + view actions
- [x] Retaining Wall: support mode=template in controller + view actions
- [x] Fence, Pruning, Pine Needles: added support and UI hooks
- [ ] QA: append/replace behavior, budget margins carried through

## 4) Template Management (Gallery)
- [ ] Route + Controller + Blade: /calculator/templates (list)
- [ ] Filters: by type, search by name, date range
- [ ] Actions: Rename, Delete, (future) Duplicate
- [ ] Permissions: mark templates as global or owner-only (add created_by, is_global)
- [ ] QA: confirm templates list reflects changes immediately

## 5) API / Backend
- [ ] Add endpoints for rename/delete template
  - [ ] PATCH /calculator/templates/{id} (template_name)
  - [ ] DELETE /calculator/templates/{id}
- [ ] (Optional) Add GET /calculator/templates?type=... (global list)
- [ ] Ensure EstimateCalculatorController returns consistent JSON on errors

## 6) Data / Migrations
- [ ] Add DB index on calculations: (is_template, calculation_type) to speed template listing
- [ ] Backfill script (artisan cmd) to set is_template=1 for prior template rows if needed
- [ ] Verify site_visit_id nullable migration in all envs; handle foreign key gracefully

## 7) Docs
- [ ] README: Document Template Mode and in-estimate workflow
- [x] Update docs/WORKLOG-2025-11-13-templates-and-ui.md
- [ ] Add animated GIF or screenshots of the new flow

## 8) QA / Regression
- [ ] Test mulching template save/import on: Chrome/Edge; mobile widths
- [ ] Verify calculations import with budget margin logic (CalculationImportService)
- [ ] Verify append vs replace behavior on repeated imports
- [ ] Verify route list for new endpoints: `php artisan route:list | Select-String "calculator"`
- [ ] Verify error handling (invalid template id, missing estimate, etc.)

## 9) Nice-to-haves (Optional)
- [ ] Result footer: allow selecting Work Area and pass area_id to import
- [ ] Inline spinners on Save & Append/Replace to avoid double submit
- [ ] Template tags (e.g., Residential, Commercial, Beds, Trees)
- [ ] Duplicate estimate items into a new estimate
- [ ] Apply default Work Area on import and allow user override

## File Pointers
- Routes: `routes/web.php`
- Controllers: `MulchingCalculatorController`, `EstimateCalculatorController`, `SiteVisitController`, `SynTurfCalculatorController`, plus other calculator controllers (Fence, Planting, Pruning, Pine Needles, Retaining Wall, Paver Patio, Weeding, Turf Mowing)
- Views:
  - Estimate: `resources/views/estimates/show.blade.php`
  - Syn-Turf form: `resources/views/calculators/syn-turf/form.blade.php`
  - Shared partials: `resources/views/calculators/partials/*.blade.php`
- Services: `app/Services/CalculationImportService.php`, `app/Services/SynTurfMaterialService.php`, `app/Services/LaborCostCalculatorService.php`
- Config: `config/syn_turf.php`
- Seeders: `database/seeders/ProductionRateSeeder.php`, data: `database/seeders/data/production_rates.json`

## Commands
- Clear caches: `php artisan optimize:clear`
- Migrate: `php artisan migrate`
- Seed production rates (important for Syn-Turf changes): `php artisan db:seed --class=ProductionRateSeeder`
- Views cache clear: `php artisan view:clear`
- Assets: `npm run dev` or `npm run build`
- Route check: `php artisan route:list | Select-String "calculator"`

---
Add owners and timestamps next to tasks as you work through the list.
