# TODO – 2025-11-14 (Templates + Calculator UX + Syn-Turf Enhancements)

Current status summary is at the top; detailed tasks follow.

## Current Status (as of 2025-11-14)
- Auth/Login branding: company logo, brand color accents, enlarged logo, gradient card, stronger ring, compact/transparent variants, welcome heading.
- Branded UI components: reusable page header (variant primary/compact) and brand buttons wired across Contacts, Estimates, Materials, Labor, Assets, Calendar, Production Rates, Templates Gallery, Site Visits.
- Sidebar reorg: Client Hub to top, Admin to bottom, added Users under Admin (CRUD screens), gated by manage-users.
- Estimates Show: compact branded header with standardized action buttons.
- Production Rates: modernized UI with multi-row edit, bulk Save All, dirty indicators, unsaved count, beforeunload guard, row highlight on save, row delete.
- Contacts/Properties address autocomplete: migrated to Google Places UI for new keys using Extended Component Library place picker, parses into address/city/state/zip (+ subpremise).
- Template Mode implemented for: Mulching, Syn-Turf, Paver Patio, Retaining Wall, Weeding, Turf Mowing, and extended to Planting, Fence, Pruning, Pine Needles.
- Estimate page:
  - “Add via Calculator” drawer with Templates tab and Refresh button.
  - Refresh button added to the page; auto-refresh and spinner wired to common item actions.
  - Work area headers now use area names instead of raw IDs (no more “Area 5” labels).
- Append/Replace from calculator results: fixed to redirect to estimates.show and to post estimate_id/calculation_id reliably.
- Syn-Turf enhancements:
  - Production rates updated: faster infill (0.0025 hr/sqft), excavation via CY for equipment, added base_install (0.20 hr/cy).
  - Excavation Method toggle in form (Generic/Skid Steer/Mini Skid) + Excavation Depth (in) => CY.
  - ABC and Rock Dust added as separate materials (CY) via independent depths.
  - Motorized hand tamper rental added as a fee ($125/day) with Rental Days input.

Use this checklist to continue the templates work and polish the calculator UX inside Estimates.

---

Status Update – 2025-11-15
- Contacts / Address UX
  - Added city/state/postal_code columns to clients (contacts). Migration added; run php artisan migrate.
  - UI Kit place picker polished: increased font-size/min-height (1.25rem, 56px) to match form; hide backing street inputs when picker is present; show existing address readonly on edit.
  - More robust placechange handling for UI Kit: reliably extracts Place and fetches addressComponents, filling City/State/Zip.
  - Contacts form: normalized City/State/Postal labels and input sizes to match form.
  - Fixed Contacts header subtitle (removed inline @if in attribute) to avoid stray code rendering.
  - Added compact theme header to Contacts Edit.
- Properties UX
  - Increased place picker font/height to match form.
  - Added compact theme header with initials avatar to Properties Create/Edit.
- Estimates
  - Fixed truncated inline script on estimate show (restored enterEditMode tail, closed template literal/function); resolved "Unexpected end of input" and restored inline item editing.

Status Update – 2025-11-14 EOD
- To‑Do Kanban
  - Added “Future” status/bucket with auto-assignment when due_date > 30 days
  - Added Hide Future and Hide Completed filters; Future column is always visible; drag-and-drop preserved
  - Changed todos.status to string (migration) to support new statuses
- Contacts Revamp
  - New tabbed layout (Info, Properties, Estimates, Invoices, Communications)
  - Properties: Quick Add slide‑over; inline “Set Primary” action
  - Communications: timeline with To‑Dos (inline status), Estimate Email events, and Site Visits; filters for type/status/date
  - Fixed edit flow redirects and added phone input masking + server normalization to (XXX) XXX-XXXX
- Estimates UX
  - Global toast helper added so success/error toasts display consistently
  - Drawer and templates tab wired; imports append/replace and totals refresh
- Misc
  - Sidebar icons unified for Admin items (Production Rates, Company Budget, Materials)
  - Invoices tab fixed to query via estimates.client_id (no invoices.client_id)

Remaining (near term)
- Address Autocomplete polish (High)
  - [x] Normalize font/height across browsers; ensure consistent ~20px text in picker (1.25rem, 56px).
  - [ ] Confirm robust parsing for non-US formats; improve fallback parsing where addressComponents are partial. (Current fallback: locality | sublocality | postal_town; AAL1 short/long; postal_code)
  - [ ] Add optional map preview under the picker (deferred).
- Place Picker wiring (High)
  - [x] Ensure no conflicting loaders exist (classic Maps JS). Keep only Extended Component Library (classic script not loaded; classic Autocomplete used only if available without loader conflict).
  - [x] Hide backing street inputs when picker is present; show readonly on edit forms so the current address is visible.
  - [ ] Add small debug log/badge behind a flag to verify init on target envs.
- Calculators
  - QA append/replace and budget margin behavior across all calculators
  - Ensure EstimateCalculatorController returns consistent JSON on errors
  - README + GIF/screenshots for Template Mode and in-estimate workflow
- Contacts/Comms polish
  - Optional: AJAX (no-reload) inline To‑Do edits; chip filters; toasts after inline actions
  - Properties: convert Edit to slide‑over; add toasts for Quick Add / Set Primary
  - Mobile QA for tabs/slide-overs
- Templates/Gallery
  - Cross-browser QA (Chrome/Edge/Safari) + mobile widths
  - Optional: template tags; duplicate estimate into new estimate; default Work Area on import
- Data
  - Optional backfill script to set is_template=1 on legacy rows if needed

Open Issues (Actionable)
- Places Autocomplete (New keys) — 2025-11-15
  - [x] New customers restricted from classic Autocomplete; migrated to UI Kit (Place Picker/PlaceAutocompleteElement) with explicit field fill.
  - [x] Switched loaders multiple times to isolate conflicts; final approach: Extended Component Library loader only (no classic script).
  - [ ] Edge case: Some pages may not render the picker due to layout overrides; add guard logs and per-page selectors.
  - [ ] Confirm referrer restrictions and API enablement across environments; add docs.
- Materials (Bulk actions 404 + UX)
  - [ ] 404 on POST /materials/bulk (prod/dev). Action plan:
    - [ ] Ensure app is served from public (vhost docroot -> .../landscape-app/public; AllowOverride All). Restart Apache.
    - [ ] Remove/rename any physical folder named "materials" at project root that could shadow the route.
    - [ ] Clear caches: php artisan optimize:clear; verify route exists: php artisan route:list | Select-String "materials/bulk".
    - [ ] Base path correctness: form action uses request()->getSchemeAndHttpHost() . request()->getBaseUrl() . '/materials/bulk' to support subdir installs.
    - [ ] Temporary diagnostics: GET /materials/bulk (ping) and alt path POST /catalog/materials/bulk + /index.php fallback to bypass rewrite. Verify, then revert to route('materials.bulk') once stable and remove temp routes.
    - [ ] Permissions: confirm current user passes can:manage-catalogs (role=admin).
  - [ ] End-to-end QA of actions: delete / set_active / set_inactive / set_category. Add confirm dialog for delete and disable Apply until an action is selected. Success toasts for each.
  - [ ] Cross-page select: add “Select all matching search” (acts on current filter query). Backend supports all_matching=true and current filters; when true, ignore ids[] and act on filtered query.
  - [ ] Performance/safety: chunk updates/deletes; consider soft-deletes for audit; validate no FK constraints will break deletes.
- Contacts / Client navigation to Site Visits and Calculators
  - [x] Client page header: add Site Visits, + New Site Visit, and "+ Add via Calculator" dropdown (links to site-visit selector then calculator form).
  - [ ] Add redundant "+ New Site Visit" button inside the Properties tab for discoverability.
  - [ ] Consider a floating “+” on mobile exposing: New Site Visit, New Estimate, Add via Calculator.
  - [ ] QA: Select-site-visit → calculator flow; ensure site_visit_id is carried; back navigation returns to client.
- Calculator select-site-visit UX
  - [ ] Validate redirect_to is a valid, allowed route; show toast on invalid.
  - [ ] Preserve existing query params when appending site_visit_id; avoid double ?.
  - [ ] Optional: preselect latest site visit for the same client; add client filter/search.
- Syn‑Turf
  - [ ] Move Excavation Method toggle higher in the form for visibility.
  - [ ] Optional: auto-calc tamper rental days (ceil(total hours / 8)) with manual override.
  - [ ] Result footer: allow selecting Work Area and pass area_id on import.
- Template Mode
  - [ ] README + screenshots/GIFs for Template Mode and estimate drawer flow.
  - [ ] Final QA of append/replace and budget margins across all calculators.
- Estimate Drawer
  - [ ] Confirm Template Gallery pre-filters by calculator type and supports Work Area selection on import.

Ideas / Backlog
- Address autocomplete: optional inline “Address set” chip/toast on selection (and a small map preview under the field).
- Address UX follow-ups:
  - Add a Clear Address action that resets street + City/State/Zip.
  - Normalize US state to 2-letter uppercase on save; format ZIP as 5 or ZIP+4.
  - Add Address Line 2 to Contacts and auto-fill subpremise when present (mirrors Properties).
  - Pre-seed the picker on edit with the stored address text to improve visual continuity.
  - Add a debug flag (e.g., window.PLACES_DEBUG) to log the place object when selections are made.
- EmailLog table for granular email events (type, recipients, subject) beyond estimate-level counts
- Per-user preferences: last active contact tab, Comms filter defaults, Kanban visibility defaults
- Duplicate estimate items into a new estimate; optional multi-select import between estimates
- Spinners on Save & Append/Replace to avoid double submit; toasts standardized across pages
- EmailLog table for granular email events (type, recipients, subject) beyond estimate-level counts
- Per-user preferences: last active contact tab, Comms filter defaults, Kanban visibility defaults
- Duplicate estimate items into a new estimate; optional multi-select import between estimates
- Spinners on Save & Append/Replace to avoid double submit; toasts standardized across pages


## 1) Estimate UI – “Add via Calculator” Modal/Drawer
- [x] Add a modal/drawer on estimates.show for “Add via Calculator” (top right actions) — Owner: AI, 2025-11-14
- [x] Two tabs: "Create with Calculator" | "Templates" — Owner: AI, 2025-11-14
- [x] Create tab:
  - [x] Button: “Open Mulching (Template Mode)” -> /calculators/mulching?mode=template&estimate_id={id} (implemented as dynamic per selected calculator) — Owner: AI, 2025-11-14
  - [ ] (Stretch) Inline mini-form for Mulching (Template Mode) with Save Template / Import
- [x] Templates tab:
  - [x] Load templates via GET estimates/{estimate}/calculator/templates?type={type} — Owner: AI, 2025-11-14
  - [x] Show name + date (basic list) — Owner: AI, 2025-11-14
  - [x] Import (Append) and Import (Replace) buttons — Owner: AI, 2025-11-14
  - [x] Add a small “Refresh” button next to the list — Owner: AI, 2025-11-14
- [x] QA: verify success toast, reload line items, totals update — via global toast helper and estimate UI auto-refresh

## 2) Mulching Template Mode – Polish (and generalize to other calculators)
- [x] Auto-suggest template_name (e.g., "Front Beds – 2.5 yd") based on inputs — Owner: AI, 2025-11-14
- [x] Inline preview of totals (Materials/Labor/Final) near footer actions — Owner: AI, 2025-11-14
- [x] Validate template_name (required) in template mode before save — Owner: AI, 2025-11-14
- [ ] Replace toggle only shown when estimate_id present
- [x] (Stretch) Choose Work Area before import; pass area_id into import flow (gallery import supports area_id) — Owner: AI, 2025-11-14

## 3) Extend Template Mode to Other Calculators
- [x] Planting: support mode=template in controller + view actions
- [x] Retaining Wall: support mode=template in controller + view actions
- [x] Fence, Pruning, Pine Needles: added support and UI hooks
- [ ] QA: append/replace behavior, budget margins carried through — Owner: AI (pending), 2025-11-14

## 4) Template Management (Gallery)
- [x] Route + Controller + Blade: /calculator/templates (list) — Owner: AI, 2025-11-14
- [x] Filters: by type, search by name, date range — Owner: AI, 2025-11-14
- [x] Actions: Rename, Delete, Duplicate — Owner: AI, 2025-11-14
- [x] Permissions: add created_by, is_global; basic policy for view/update/delete/duplicate — Owner: AI, 2025-11-14
- [x] Import Modal: estimate search, Replace toggle, Work Area select, redirects to estimate — Owner: AI, 2025-11-14
- [x] Sidebar link to Gallery + “Go to Gallery” from estimate drawer (pre-filtered by type) — Owner: AI, 2025-11-14
- [ ] QA: confirm templates list and actions on Chrome/Edge + mobile widths

## 5) API / Backend
- [x] Add endpoints for rename/delete template — Owner: AI, 2025-11-14
  - [x] PATCH /calculator/templates/{id} (template_name)
  - [x] DELETE /calculator/templates/{id}
- [x] GET /calculator/templates?type=... (gallery filters) — Owner: AI, 2025-11-14
- [x] Duplicate endpoint: POST /calculator/templates/{id}/duplicate — Owner: AI, 2025-11-14
- [x] Import endpoint: POST /calculator/templates/{id}/import (estimate_id, replace, area_id) — Owner: AI, 2025-11-14
- [ ] Ensure EstimateCalculatorController returns consistent JSON on errors

## 6) Data / Migrations
- [x] Add DB index on calculations: (is_template, calculation_type) to speed template listing — Owner: AI, 2025-11-14
- [x] Add city/state/postal_code columns to clients (contacts) to support split address fields — Owner: AI, 2025-11-15
- [ ] Backfill script (artisan cmd) to set is_template=1 for prior template rows if needed
- [ ] Verify site_visit_id nullable migration in all envs; handle foreign key gracefully

## 7) Docs
- [ ] README: Document Template Mode and in-estimate workflow
- [x] Update docs/WORKLOG-2025-11-13-templates-and-ui.md
- [ ] Add animated GIF or screenshots of the new flow
- [ ] Address Autocomplete Guide
  - [ ] Enablement: Maps JS billing, Places API, Places UI Kit
  - [ ] Loader: Extended Component Library vs classic (choose one only)
  - [ ] Form IDs and data-* overrides (data-city-id/state-id/zip-id)
  - [ ] Styling the picker (font/height)
- [ ] README: Document Template Mode and in-estimate workflow
- [x] Update docs/WORKLOG-2025-11-13-templates-and-ui.md
- [ ] Add animated GIF or screenshots of the new flow

## 8) QA / Regression
- [ ] Test mulching template save/import on: Chrome/Edge; mobile widths
- [ ] Verify calculations import with budget margin logic (CalculationImportService)
- [ ] Verify append vs replace behavior on repeated imports
- [ ] Verify route list for new endpoints: `php artisan route:list | Select-String "calculator"`
- [ ] Verify error handling (invalid template id, missing estimate, etc.)

## 9) Nice-to-haves (Optional)
- [ ] Result footer: allow selecting Work Area and pass area_id to import
- [ ] Inline spinners on Save & Append/Replace to avoid double submit
- [ ] Template tags (e.g., Residential, Commercial, Beds, Trees)
- [ ] Duplicate estimate items into a new estimate
- [ ] Apply default Work Area on import and allow user override

## File Pointers
- Routes: `routes/web.php`
- Controllers: `MulchingCalculatorController`, `EstimateCalculatorController`, `SiteVisitController`, `SynTurfCalculatorController`, plus other calculator controllers (Fence, Planting, Pruning, Pine Needles, Retaining Wall, Paver Patio, Weeding, Turf Mowing)
- Views:
  - Estimate: `resources/views/estimates/show.blade.php`
  - Syn-Turf form: `resources/views/calculators/syn-turf/form.blade.php`
  - Shared partials: `resources/views/calculators/partials/*.blade.php`
- Services: `app/Services/CalculationImportService.php`, `app/Services/SynTurfMaterialService.php`, `app/Services/LaborCostCalculatorService.php`
- Config: `config/syn_turf.php`
- Seeders: `database/seeders/ProductionRateSeeder.php`, data: `database/seeders/data/production_rates.json`

## Commands
- Clear caches: `php artisan optimize:clear`
- Migrate: `php artisan migrate`
- Seed production rates (important for Syn-Turf changes): `php artisan db:seed --class=ProductionRateSeeder`
- Views cache clear: `php artisan view:clear`
- Assets: `npm run dev` or `npm run build`
- Route check: `php artisan route:list | Select-String "calculator"`

---

Quick Fixes – 2025-11-15
- Contacts/Properties
  - Normalized picker font/height; ensured split City/State/Zip fill on UI Kit placechange.
  - Address input visibility: hide when empty (picker visible), show readonly when existing value on edit forms.
  - Contacts header subtitle fixed to avoid inline Blade @if inside attribute.
  - Removed duplicate "Mulching" entry in "+ Add via Calculator" menu on contact header.
- Estimates
  - Fixed broken inline script on estimate show; restored JS and eliminated syntax error.

Quick Fixes – 2025-11-14 PM
- Client page header navigation
  - Added buttons: Site Visits, + New Site Visit, and "+ Add via Calculator" dropdown (to site-visit selector → calculator). File: resources/views/clients/show.blade.php
  - Next: add "+ New Site Visit" in Properties tab, consider mobile FAB for quick actions.
- Materials bulk diagnostics/workarounds
  - Added temporary GET ping at /materials/bulk and alt route POST /catalog/materials/bulk to bypass any /materials/* collisions; adjusted form action to respect baseUrl.
  - Next: once verified on target environment, revert form action to route('materials.bulk'), remove ping/alt routes, and keep docroot on /public.

Diagnostics / Commands
- php artisan optimize:clear
- php artisan route:list | Select-String "materials"
- Verify GET /materials/bulk shows "bulk ping" (diagnostic); verify POST /catalog/materials/bulk succeeds end-to-end; then switch back to /materials/bulk

Add owners and timestamps next to tasks as you work through the list.
